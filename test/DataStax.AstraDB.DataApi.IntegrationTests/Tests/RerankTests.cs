using DataStax.AstraDB.DataApi.Collections;
using DataStax.AstraDB.DataApi.Core;
using DataStax.AstraDB.DataApi.Core.Query;
using DataStax.AstraDB.DataApi.IntegrationTests.Fixtures;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Xunit;

namespace DataStax.AstraDB.DataApi.IntegrationTests;

[Collection("RerankCollection")]
public class RerankTests : IClassFixture<RerankFixture>
{
    private readonly RerankFixture _fixture;
    private readonly Collection<HybridSearchTestObject> _collection;

    public RerankTests(RerankFixture fixture)
    {
        _fixture = fixture;
        _collection = fixture.HybridSearchCollection;
    }

    [Fact]
    public async Task FindAndRerank_BasicSearch_ReturnsResults_WithAsyncEnumeration()
    {
        var searchResultsList = new List<HybridSearchTestObject>();
        var results = _collection.FindAndRerank<HybridSearchTestObject>()
            .Sort("cat");
        await foreach (var result in results)
        {
            searchResultsList.Add(result);
        }
        Assert.NotNull(searchResultsList);
        Assert.NotEmpty(searchResultsList);
        Assert.Contains(searchResultsList, r => r.Name == "Cat");
    }

    [Fact]
    public void FindAndRerank_BasicVectorAndLexicalSearch_ReturnsResults()
    {
        var lexicalQuery = "cat";
        var vectorQuery = new float[] { -0.032348633f, 0.021102905f, -0.0020217896f, -0.038208008f, -0.0070228577f, 0.019866943f, -0.023010254f, -0.0057525635f, 0.029373169f, -0.042388916f, 0.021881104f, 0.018707275f, 0.004951477f, 0.021560669f, 0.018615723f, 0.01210022f, -0.028274536f, -0.0317688f, 0.0015859604f, 0.012504578f, 0.020477295f, 0.038482666f, 0.04727173f, 0.03869629f, 0.012176514f, 0.055480957f, 0.0018234253f, -0.023666382f, 0.046020508f, 0.0418396f, -0.04284668f, -0.07733154f, 0.020080566f, -0.015701294f, 0.012641907f, -0.026535034f, 0.021026611f, -0.01361084f, -0.042053223f, 0.0051002502f, 0.047058105f, -0.016952515f, -0.0041046143f, -0.008255005f, 0.006538391f, 0.00793457f, -0.03668213f, -0.03842163f, 0.027923584f, -0.033325195f, 0.044677734f, -0.037750244f, 0.043792725f, -0.008148193f, -4.6658516E-4f, 0.027404785f, 0.062805176f, 0.06713867f, -0.03552246f, -0.031311035f, -0.0049743652f, -0.09277344f, 0.023544312f, -8.029938E-4f, 6.3562393E-4f, 0.05480957f, -0.029632568f, -0.005596161f, 0.016052246f, -0.05142212f, 0.033813477f, -0.011146545f, -0.009048462f, 0.0027103424f, 0.006793976f, -0.04067993f, -0.00774765f, 0.0340271f, 0.054718018f, 0.046081543f, 0.038146973f, 0.023483276f, -0.007472992f, 0.009315491f, 0.0289917f, 0.006587982f, 0.034973145f, -0.07128906f, 0.0053596497f, 0.007133484f, 0.0069618225f, -0.020263672f, 0.04147339f, -0.019165039f, -0.00818634f, -0.022369385f, -0.018096924f, 0.004878998f, -0.017028809f, -0.020935059f, 0.014099121f, -0.036621094f, 0.05444336f, 0.031585693f, -0.020233154f, 0.035217285f, -0.01222229f, 0.008430481f, -8.9502335E-4f, 0.0041618347f, -0.023269653f, -0.007369995f, 0.023269653f, 0.045135498f, 0.015670776f, -0.036956787f, -0.022903442f, -0.015266418f, 0.015609741f, 0.0690918f, -0.016220093f, -0.047088623f, 7.8344345E-4f, -0.0013170242f, 4.0888786E-4f, 0.042388916f, 0.011291504f, -8.72612E-4f, 0.004714966f, 0.024536133f, -0.046905518f, -0.0385437f, 0.014793396f, 0.0023384094f, 0.04888916f, -0.051239014f, -0.1303711f, -0.045898438f, 0.03756714f, -0.02935791f, -0.031402588f, -0.07470703f, -0.02079773f, 0.022918701f, 0.064697266f, 0.054870605f, -0.0030708313f, 0.0690918f, 0.006389618f, 0.035980225f, -0.030685425f, -0.019683838f, 0.007911682f, 0.01083374f, 0.020141602f, -0.050201416f, 0.03982544f, -0.014724731f, 0.02507019f, 0.013755798f, 0.014076233f, -0.0013895035f, -0.028320312f, -0.010955811f, -0.034423828f, -0.022827148f, 0.037506104f, -0.002040863f, 0.003982544f, 0.062561035f, 0.0345459f, -0.0022239685f, 0.035339355f, 0.04937744f, 0.029769897f, -0.039733887f, 0.005794525f, -0.0135650635f, -0.021774292f, 0.026870728f, -0.025039673f, -0.009223938f, 0.024597168f, 0.0289917f, 0.011695862f, 0.045837402f, -0.047668457f, -0.081604004f, 0.041259766f, -0.040100098f, -0.046905518f, -0.014923096f, 0.040161133f, -0.048797607f, -0.0068626404f, -0.043395996f, 0.03579712f, 0.011192322f, -0.012359619f, -0.023483276f, -0.0418396f, 0.02748108f, 0.014137268f, -0.0025177002f, 0.02432251f, 0.039093018f, 0.018661499f, -0.02243042f, 0.006576538f, -0.012031555f, -0.045654297f, -0.04159546f, -0.013946533f, -0.007472992f, 0.008872986f, 0.006576538f, 0.024795532f, -0.0031147003f, -0.040771484f, 0.034729004f, 0.01473999f, 0.062805176f, -0.009857178f, -0.022994995f, -0.013000488f, 0.008071899f, -0.012161255f, -0.014442444f, -0.040496826f, -0.032104492f, -0.05404663f, -0.0118637085f, 0.038208008f, -0.023361206f, -0.038238525f, 0.0102005005f, 0.0054969788f, -0.009132385f, 0.03378296f, 0.024536133f, -0.017410278f, 0.0062828064f, 0.011413574f, 0.0027256012f, -0.004283905f, 6.723404E-4f, 0.045806885f, 0.020645142f, 0.01876831f, -0.04196167f, -0.030532837f, 0.02279663f, -0.018127441f, -0.026489258f, 0.051513672f, -0.0385437f, 0.03729248f, -0.03668213f, 0.0059890747f, 0.025344849f, -0.04046631f, 0.044952393f, 0.027374268f, -0.0046691895f, -0.010978699f, 0.0018043518f, -0.02444458f, -0.030532837f, 0.06842041f, -0.025024414f, 0.01335907f, 0.018218994f, -0.038482666f, 0.018463135f, 0.009262085f, 0.028015137f, -0.019104004f, 0.0057411194f, 0.02758789f, -0.017501831f, -0.042755127f, -0.05218506f, -0.014190674f, 0.04324341f, -0.023452759f, 0.022476196f, -0.047332764f, -0.008415222f, 0.0345459f, 0.0058021545f, 0.027038574f, -0.0077209473f, -0.0067596436f, -0.031097412f, 0.039978027f, -0.03866577f, 0.0066337585f, 0.005908966f, 0.046783447f, 0.010917664f, 7.9774857E-4f, 0.005039215f, 0.006134033f, -0.056488037f, -0.014984131f, -0.009284973f, 0.012283325f, -0.0059547424f, -0.011070251f, 0.062438965f, -0.0010519028f, -0.022201538f, -0.0027637482f, -0.029525757f, -0.028533936f, 0.015403748f, 0.046020508f, 0.009262085f, 0.013923645f, 0.017745972f, 0.061462402f, 0.048217773f, -0.068359375f, 0.023956299f, -0.010009766f, -0.017333984f, 0.029281616f, 0.01171875f, -0.006111145f, 0.035827637f, -0.05444336f, 0.028869629f, -0.028457642f, 0.012672424f, -0.007965088f, -0.029205322f, 0.016830444f, 0.037902832f, -0.02407837f, -0.017807007f, 0.031341553f, -0.0067367554f, 0.011680603f, -0.023910522f, -0.01171875f, 0.015571594f, -0.0047302246f, 0.0039405823f, -0.021438599f, 0.013870239f, -0.028961182f, 0.030334473f, -0.005268097f, -0.039855957f, -0.009223938f, 0.01574707f, 0.030975342f, 0.032104492f, -0.031402588f, 0.026657104f, 0.06604004f, -0.012687683f, -0.050048828f, -0.072021484f, 0.0020809174f, 0.05609131f, 0.002796173f, 0.0019798279f, -0.0012483597f, 0.037109375f, 0.035003662f, 0.03225708f, -0.015975952f, 0.005596161f, -0.025344849f, -0.0059776306f, 0.0037078857f, 0.021835327f, -0.006412506f, 0.018661499f, 0.011886597f, 0.009757996f, 0.019714355f, 0.010444641f, -0.06781006f, -0.056610107f, 0.028274536f, 0.018051147f, 0.0049819946f, -0.045532227f, -1.7368793E-4f, 0.04763794f, -0.028793335f, -0.044799805f, 0.0036792755f, -0.022247314f, 0.030532837f, -0.02861023f, 0.010040283f, 0.015792847f, 0.015136719f, 0.084106445f, -0.021026611f, -0.026657104f, 0.004096985f, 0.05618286f, -0.028915405f, -0.03314209f, -2.6583672E-4f, 0.032958984f, 0.041900635f, 0.032409668f, 0.028656006f, 7.092953E-5f, 0.009605408f, -0.0053138733f, 0.044677734f, -0.018859863f, 0.016601562f, 0.016143799f, -0.054718018f, -0.010719299f, -0.028457642f, 0.010551453f, -0.032165527f, -0.0036716461f, 0.008834839f, 0.0287323f, -0.010536194f, 0.022201538f, -0.0065994263f, 0.053619385f, -0.035705566f, -0.04034424f, -0.03933716f, -0.006664276f, -0.034362793f, 0.036865234f, 0.006111145f, 0.027038574f, 0.059326172f, -0.005012512f, 0.0034713745f, -0.055419922f, -0.040802002f, 0.017501831f, 0.011711121f, -0.06378174f, 0.0038585663f, -0.006793976f, 0.0067825317f, 0.0075416565f, -0.010269165f, 0.0069007874f, -0.1381836f, 0.015174866f, -0.030639648f, 0.054718018f, -0.042388916f, 0.008590698f, -0.04864502f, -0.017501831f, -0.014442444f, 0.009010315f, 0.0073394775f, -0.06744385f, -0.004360199f, -0.0034923553f, 0.005886078f, 0.025924683f, 0.010429382f, -0.0039711f, -0.0098724365f, -0.013214111f, -0.0013942719f, 0.031829834f, 7.9488754E-4f, -0.02407837f, 3.8933754E-4f, -6.122589E-4f, 0.0027122498f, 0.041534424f, 0.045288086f, -0.004348755f, -0.048980713f, 0.018920898f, -0.008811951f, 0.0021820068f, 0.018035889f, 0.009437561f, 0.05618286f, -0.052124023f, -0.020645142f, -0.034851074f, -0.02784729f, -0.0010900497f, -0.009483337f, -0.0013189316f, -0.012878418f, 0.025604248f, 0.035980225f, 0.0041503906f, -0.024261475f, -0.014831543f, -0.005622864f, 0.03668213f, -0.048217773f, 0.015609741f, -0.013885498f, 0.0118637085f, 0.04269409f, -0.06512451f, 0.014190674f, -0.013175964f, -0.016860962f, -0.0062675476f, 0.008270264f, 0.047821045f, 0.020629883f, -0.0065193176f, 6.213188E-4f, -0.04348755f, -0.04977417f, -0.0033779144f, -0.017578125f, -0.021469116f, -0.0044021606f, -0.014343262f, -0.033050537f, -0.017959595f, -0.038848877f, -0.0018701553f, -0.034698486f, 0.024658203f, -0.014701843f, -0.00907135f, 0.0042915344f, -0.08880615f, -0.025985718f, 0.046875f, 0.027511597f, 0.013664246f, -0.03213501f, 0.101135254f, 0.038330078f, 0.013519287f, -0.044036865f, -0.010826111f, -0.035614014f, 0.026306152f, -0.0040016174f, 0.0048179626f, 0.008850098f, -0.008255005f, -0.031921387f, -0.0121154785f, 0.015213013f, 0.013076782f, 0.013381958f, 0.009338379f, -0.0143585205f, 0.014305115f, 0.040222168f, -0.038879395f, -0.019363403f, 0.010734558f, 0.03213501f, -0.043182373f, -0.0069732666f, -0.018585205f, -0.028564453f, 0.036621094f, -0.041870117f, 0.01525116f, 0.015808105f, 0.0038928986f, 0.022994995f, 0.06689453f, -0.0079956055f, -0.0029888153f, 0.0440979f, 0.008834839f, -0.0063591003f, 0.023880005f, -0.020584106f, -0.0463562f, -0.0036201477f, 0.011680603f, -0.013076782f, -0.028121948f, 0.028274536f, 0.009483337f, 0.0053901672f, 0.019439697f, -0.054718018f, 0.020477295f, -0.0074424744f, -0.04269409f, 0.018798828f, -0.0035705566f, 0.016174316f, -0.0030021667f, 0.007987976f, -0.025161743f, -0.027038574f, 0.017852783f, -0.018356323f, 0.016098022f, -0.010009766f, 0.01838684f, 0.07531738f, -0.006801605f, -0.004257202f, 0.015571594f, 0.037750244f, 0.04751587f, -0.03967285f, 0.03491211f, 0.009918213f, 0.035217285f, 0.007068634f, 0.0059165955f, -0.007850647f, 0.047088623f, -0.010536194f, -0.054901123f, -0.015930176f, 0.0071525574f, -0.05758667f, 0.017532349f, -0.034820557f, -0.024414062f, 0.013252258f, -0.03677368f, -0.0028648376f, -0.017868042f, -0.007987976f, -0.030792236f, 0.048034668f, 0.0067214966f, 0.045684814f, -0.0051879883f, -0.028152466f, 0.04815674f, 0.013923645f, 0.044799805f, 6.23703E-4f, -0.089538574f, -0.004173279f, -0.02947998f, -0.015319824f, 0.08105469f, -0.0028629303f, 0.011909485f, -0.011245728f, -0.022705078f, 0.060333252f, -0.012939453f, -0.0040245056f, 0.0118637085f, 0.055541992f, -0.01689148f, 0.030792236f, -0.0076828003f, 0.056549072f, 0.20996094f, 0.014930725f, 0.004497528f, -0.07965088f, 5.559921E-4f, -0.032165527f, 0.023544312f, -0.024627686f, -0.008140564f, -0.006313324f, 0.0074157715f, 0.051940918f, 0.029327393f, 0.016525269f, 0.026321411f, 0.087646484f, -0.016021729f, -0.022949219f, 0.01802063f, 0.010513306f, 0.016571045f, 0.058746338f, -0.0074272156f, -0.028961182f, 0.0063056946f, -0.018463135f, 0.01676941f, -0.019119263f, 0.009338379f, 0.027938843f, -0.07611084f, 0.014305115f, -0.05328369f, 0.034606934f, 0.009315491f, -0.00680542f, 0.009262085f, 0.021347046f, -0.04296875f, 0.026428223f, 0.012413025f, -0.011665344f, -0.0129470825f, -0.0059814453f, -0.021347046f, -0.023788452f, -0.04449463f, -0.005569458f, -0.027328491f, 0.04736328f, -0.051940918f, 0.036712646f, 0.034210205f, -0.025024414f, 0.031982422f, -0.0031108856f, 0.0046463013f, -0.04562378f, -0.036315918f, -0.10223389f, 0.019515991f, 0.012481689f, 0.03866577f, -0.01776123f, -0.01512146f, -2.515316E-5f, 0.0017700195f, 0.039245605f, 0.036956787f, -0.006088257f, 0.05218506f, 0.018829346f, -0.019256592f, -0.03050232f, 0.022659302f, 0.010932922f, 0.034362793f, 0.028274536f, -0.038238525f, -0.011421204f, -0.047729492f, 0.008384705f, 0.026397705f, -0.0012645721f, -0.040863037f, 0.016220093f, 0.036102295f, -0.018249512f, 0.023010254f, 0.012809753f, -0.02571106f, 0.018707275f, -0.019989014f, 0.0118637085f, -0.0109939575f, 0.04095459f, -0.00844574f, 0.013458252f, -0.022277832f, 0.041748047f, 0.051208496f, 0.008987427f, -0.027038574f, 0.056243896f, 0.048339844f, -0.016693115f, 0.034210205f, -0.040771484f, -0.037841797f, 0.008392334f, -0.0034732819f, -0.015670776f, -0.01121521f, -0.077697754f, -0.031173706f, -0.04095459f, -0.029449463f, -0.026428223f, 0.021102905f, -0.02520752f, 0.027450562f, -0.04095459f, -0.0024967194f, -0.057373047f, -0.0038585663f, 0.0039711f, 0.014526367f, -0.053527832f, -0.0030097961f, -0.04763794f, 0.012466431f, 0.016555786f, 0.02281189f, -0.0031032562f, 0.04107666f, 0.0146102905f, -9.717941E-4f, 0.030166626f, -0.04977417f, -0.019073486f, -0.010795593f, -0.030151367f, -0.02204895f, -0.011169434f, -0.05038452f, 0.027923584f, 0.05569458f, -0.0047073364f, 0.027252197f, -0.00111866f, -0.091308594f, -0.0073509216f, -0.02583313f, -0.021377563f, -0.019104004f, 0.0032577515f, -0.025970459f, -0.0146102905f, -0.038482666f, 0.005405426f, 0.05001831f, 0.0071144104f, 0.025604248f, -0.005302429f, 0.0087509155f, 0.003326416f, 0.03086853f, 0.022369385f, 0.023330688f, -0.01322937f, 0.009284973f, 0.06903076f, 0.023910522f, 0.02709961f, -0.05444336f, -0.002943039f, 0.02180481f, -0.029663086f, 0.04763794f, -0.025436401f, -0.017532349f, 0.062805176f, 0.00497818f, 0.030883789f, -0.046020508f, -0.025131226f, 0.0063819885f, 0.011726379f, 0.013641357f, -0.0069732666f, 0.0071792603f, -0.0129852295f, 0.024353027f, 0.014724731f, 0.02015686f, 0.020874023f, -0.009552002f, -0.002729416f, 0.0057258606f, -0.033569336f, 0.05999756f, -0.03414917f, 0.003276825f, 0.029846191f, 0.049591064f, -0.019241333f, 0.045135498f, 0.04547119f, -0.012565613f, 0.03201294f, 0.019012451f, -0.03668213f, -0.031341553f, 0.012420654f, 0.043762207f, 0.03050232f, 0.007095337f, -0.008636475f, 0.009414673f, -0.015991211f, -0.062438965f, 0.0413208f, -0.009811401f, 0.008613586f, 4.4178963E-4f, 0.024734497f, -0.004047394f, 0.0055770874f, -0.02758789f, -0.0012454987f, 0.0413208f, -0.008331299f, -0.05014038f, -6.637573E-4f, -0.0047912598f, 0.006980896f, 0.010871887f, 0.0036201477f, 0.026489258f, -0.02973938f, -0.0345459f, -0.02507019f, 0.0063819885f, -0.0017623901f, -0.025970459f, -0.037902832f, 0.0357666f, 0.08380127f, -0.026000977f, 0.014152527f, 0.0032482147f, -0.013473511f, 0.0049819946f, -0.014213562f, 0.022201538f, -0.02784729f, 0.019592285f, 0.0019550323f, -0.011741638f, -0.020858765f, -0.022918701f, 0.02368164f, -0.023773193f, -0.008674622f, -0.011001587f, 0.035736084f, -0.010154724f, -0.035064697f, -0.03753662f, -0.053985596f, -0.01436615f, -8.7070465E-4f, 4.887581E-4f, -0.051605225f, 0.019607544f, 0.036132812f, -0.032928467f, -0.018920898f, -0.024658203f, 0.022827148f, 0.06378174f, 0.064575195f, -0.028656006f, 0.037475586f, 0.046722412f, 0.024871826f, 0.0047073364f, -0.009902954f, -0.03086853f, 2.8252602E-4f, -0.012207031f, 0.00831604f, -0.04421997f, 0.02406311f, -0.005908966f, -0.011940002f, 0.015563965f, 0.010757446f, -0.013648987f, 0.019821167f, 0.041656494f, 0.048461914f, 0.035705566f, -0.004135132f, 0.020980835f, -0.0033550262f, 0.01096344f, 0.016067505f, 0.0178833f, 0.0012598038f, 0.0046691895f, 0.046875f, -0.02381897f, 0.004501343f, 0.026657104f, -0.004798889f, 0.05871582f, 0.0025024414f, 0.017562866f, -0.0017290115f, -0.0077209473f, 0.04348755f, -0.011116028f, 0.007499695f, 0.039031982f, 0.014457703f, -0.010559082f, 0.009048462f, 0.03765869f, -0.012161255f, 0.00283432f, -0.012458801f, 0.05368042f, 0.011909485f, -0.023773193f, -0.0033168793f, -0.009674072f, 0.023117065f, -0.0058174133f, -0.0065994263f, -0.019195557f, 0.021026611f, -0.01574707f, 7.543564E-4f, -0.005077362f, -0.035217285f, -0.028320312f, 0.029403687f, 0.0029773712f, -0.015098572f, 0.034698486f, -0.0030441284f, 0.031051636f, -0.04232788f, 0.011833191f, 4.8828125E-4f, -0.014801025f, -8.404255E-5f, -0.027862549f };
        var results = _collection.FindAndRerank<HybridSearchTestObject>()
            .Sort(lexicalQuery, vectorQuery);
        var searchResultsList = results.ToList();
        Assert.NotNull(searchResultsList);
        Assert.NotEmpty(searchResultsList);
        Assert.Contains(searchResultsList, r => r.Name == "Cat");
    }

    [Fact]
    public void FindAndRerank_BasicLexicalAndVectorizeSearch_ReturnsResults()
    {
        var results = _collection.FindAndRerank<HybridSearchTestObject>()
            .Sort(lexical: "not a cat", vectorize: "cat")
            .IncludeSortVector(true);
        var searchResultsList = results.ToList();
        var sortVector = results.GetSortVectorAsync();
        Assert.NotNull(searchResultsList);
        Assert.NotEmpty(searchResultsList);
        Assert.Contains(searchResultsList, r => r.Name == "Cat");
    }

    [Fact]
    public void FindAndRerank_WithLimit_ReturnsLimitedResults()
    {
        var query = "animal";
        var limit = 2;

        var results = _collection.FindAndRerank<HybridSearchTestObject>()
            .Sort(query)
            .Limit(limit)
            .ToList();

        Assert.True(results.Count <= limit);
    }

    [Fact]
    public void FindAndRerank_WithFilter_ReturnsFilteredResults()
    {
        var results = new List<HybridSearchTestObject>();
        var filter = Builders<HybridSearchTestObject>.Filter.Eq("Name", "Horse");
        var query = _collection.FindAndRerank<HybridSearchTestObject>(filter)
            .Sort("cat")
            .ToList();

        Assert.NotNull(results);
        Assert.All(results, r => Assert.Equal("Horse", r.Name));
    }

    [Fact]
    public async Task FindAndRerank_WithIncludeScores_ReturnsScores()
    {
        var results = _collection.FindAndRerank<HybridSearchTestObject>()
            .Sort("cat")
            .IncludeScores(true);

        await foreach (var result in results.WithScoresAsync())
        {
            Assert.NotNull(result.Scores);
            Assert.NotEmpty(result.Scores);
        }
    }

    [Fact]
    public async Task FindAndRerank_WithExclusiveProjection_ExcludesProperties()
    {
        var results = new List<HybridSearchTestObject>();
        await foreach (var result in _collection.FindAndRerank<HybridSearchTestObject>()
            .Sort("cat")
            .Project(Builders<HybridSearchTestObject>.Projection.Exclude("Name")))
        {
            Assert.Null(result.Name);
        }
    }

    [Fact]
    public async Task FindAndRerank_WithIncludeSortVector_ReturnsSortVector()
    {
        var results = _collection.FindAndRerank<HybridSearchTestObject>()
            .Sort("cat")
            .IncludeSortVector(true);
        var sortVector = await results.GetSortVectorAsync();
        Assert.NotNull(sortVector);
        Assert.NotEmpty(sortVector);
    }

    [Fact]
    public void FindAndRerank_WithAllOptions_ReturnsSuccessfully()
    {
        var lexicalQuery = "cat";
        var rerankQuery = "cow";
        var results = _collection.FindAndRerank<HybridSearchTestObject>()
            .Sort(lexical: lexicalQuery, vector: new float[] { -0.032348633f, 0.021102905f, -0.0020217896f, -0.038208008f, -0.0070228577f, 0.019866943f, -0.023010254f, -0.0057525635f, 0.029373169f, -0.042388916f, 0.021881104f, 0.018707275f, 0.004951477f, 0.021560669f, 0.018615723f, 0.01210022f, -0.028274536f, -0.0317688f, 0.0015859604f, 0.012504578f, 0.020477295f, 0.038482666f, 0.04727173f, 0.03869629f, 0.012176514f, 0.055480957f, 0.0018234253f, -0.023666382f, 0.046020508f, 0.0418396f, -0.04284668f, -0.07733154f, 0.020080566f, -0.015701294f, 0.012641907f, -0.026535034f, 0.021026611f, -0.01361084f, -0.042053223f, 0.0051002502f, 0.047058105f, -0.016952515f, -0.0041046143f, -0.008255005f, 0.006538391f, 0.00793457f, -0.03668213f, -0.03842163f, 0.027923584f, -0.033325195f, 0.044677734f, -0.037750244f, 0.043792725f, -0.008148193f, -4.6658516E-4f, 0.027404785f, 0.062805176f, 0.06713867f, -0.03552246f, -0.031311035f, -0.0049743652f, -0.09277344f, 0.023544312f, -8.029938E-4f, 6.3562393E-4f, 0.05480957f, -0.029632568f, -0.005596161f, 0.016052246f, -0.05142212f, 0.033813477f, -0.011146545f, -0.009048462f, 0.0027103424f, 0.006793976f, -0.04067993f, -0.00774765f, 0.0340271f, 0.054718018f, 0.046081543f, 0.038146973f, 0.023483276f, -0.007472992f, 0.009315491f, 0.0289917f, 0.006587982f, 0.034973145f, -0.07128906f, 0.0053596497f, 0.007133484f, 0.0069618225f, -0.020263672f, 0.04147339f, -0.019165039f, -0.00818634f, -0.022369385f, -0.018096924f, 0.004878998f, -0.017028809f, -0.020935059f, 0.014099121f, -0.036621094f, 0.05444336f, 0.031585693f, -0.020233154f, 0.035217285f, -0.01222229f, 0.008430481f, -8.9502335E-4f, 0.0041618347f, -0.023269653f, -0.007369995f, 0.023269653f, 0.045135498f, 0.015670776f, -0.036956787f, -0.022903442f, -0.015266418f, 0.015609741f, 0.0690918f, -0.016220093f, -0.047088623f, 7.8344345E-4f, -0.0013170242f, 4.0888786E-4f, 0.042388916f, 0.011291504f, -8.72612E-4f, 0.004714966f, 0.024536133f, -0.046905518f, -0.0385437f, 0.014793396f, 0.0023384094f, 0.04888916f, -0.051239014f, -0.1303711f, -0.045898438f, 0.03756714f, -0.02935791f, -0.031402588f, -0.07470703f, -0.02079773f, 0.022918701f, 0.064697266f, 0.054870605f, -0.0030708313f, 0.0690918f, 0.006389618f, 0.035980225f, -0.030685425f, -0.019683838f, 0.007911682f, 0.01083374f, 0.020141602f, -0.050201416f, 0.03982544f, -0.014724731f, 0.02507019f, 0.013755798f, 0.014076233f, -0.0013895035f, -0.028320312f, -0.010955811f, -0.034423828f, -0.022827148f, 0.037506104f, -0.002040863f, 0.003982544f, 0.062561035f, 0.0345459f, -0.0022239685f, 0.035339355f, 0.04937744f, 0.029769897f, -0.039733887f, 0.005794525f, -0.0135650635f, -0.021774292f, 0.026870728f, -0.025039673f, -0.009223938f, 0.024597168f, 0.0289917f, 0.011695862f, 0.045837402f, -0.047668457f, -0.081604004f, 0.041259766f, -0.040100098f, -0.046905518f, -0.014923096f, 0.040161133f, -0.048797607f, -0.0068626404f, -0.043395996f, 0.03579712f, 0.011192322f, -0.012359619f, -0.023483276f, -0.0418396f, 0.02748108f, 0.014137268f, -0.0025177002f, 0.02432251f, 0.039093018f, 0.018661499f, -0.02243042f, 0.006576538f, -0.012031555f, -0.045654297f, -0.04159546f, -0.013946533f, -0.007472992f, 0.008872986f, 0.006576538f, 0.024795532f, -0.0031147003f, -0.040771484f, 0.034729004f, 0.01473999f, 0.062805176f, -0.009857178f, -0.022994995f, -0.013000488f, 0.008071899f, -0.012161255f, -0.014442444f, -0.040496826f, -0.032104492f, -0.05404663f, -0.0118637085f, 0.038208008f, -0.023361206f, -0.038238525f, 0.0102005005f, 0.0054969788f, -0.009132385f, 0.03378296f, 0.024536133f, -0.017410278f, 0.0062828064f, 0.011413574f, 0.0027256012f, -0.004283905f, 6.723404E-4f, 0.045806885f, 0.020645142f, 0.01876831f, -0.04196167f, -0.030532837f, 0.02279663f, -0.018127441f, -0.026489258f, 0.051513672f, -0.0385437f, 0.03729248f, -0.03668213f, 0.0059890747f, 0.025344849f, -0.04046631f, 0.044952393f, 0.027374268f, -0.0046691895f, -0.010978699f, 0.0018043518f, -0.02444458f, -0.030532837f, 0.06842041f, -0.025024414f, 0.01335907f, 0.018218994f, -0.038482666f, 0.018463135f, 0.009262085f, 0.028015137f, -0.019104004f, 0.0057411194f, 0.02758789f, -0.017501831f, -0.042755127f, -0.05218506f, -0.014190674f, 0.04324341f, -0.023452759f, 0.022476196f, -0.047332764f, -0.008415222f, 0.0345459f, 0.0058021545f, 0.027038574f, -0.0077209473f, -0.0067596436f, -0.031097412f, 0.039978027f, -0.03866577f, 0.0066337585f, 0.005908966f, 0.046783447f, 0.010917664f, 7.9774857E-4f, 0.005039215f, 0.006134033f, -0.056488037f, -0.014984131f, -0.009284973f, 0.012283325f, -0.0059547424f, -0.011070251f, 0.062438965f, -0.0010519028f, -0.022201538f, -0.0027637482f, -0.029525757f, -0.028533936f, 0.015403748f, 0.046020508f, 0.009262085f, 0.013923645f, 0.017745972f, 0.061462402f, 0.048217773f, -0.068359375f, 0.023956299f, -0.010009766f, -0.017333984f, 0.029281616f, 0.01171875f, -0.006111145f, 0.035827637f, -0.05444336f, 0.028869629f, -0.028457642f, 0.012672424f, -0.007965088f, -0.029205322f, 0.016830444f, 0.037902832f, -0.02407837f, -0.017807007f, 0.031341553f, -0.0067367554f, 0.011680603f, -0.023910522f, -0.01171875f, 0.015571594f, -0.0047302246f, 0.0039405823f, -0.021438599f, 0.013870239f, -0.028961182f, 0.030334473f, -0.005268097f, -0.039855957f, -0.009223938f, 0.01574707f, 0.030975342f, 0.032104492f, -0.031402588f, 0.026657104f, 0.06604004f, -0.012687683f, -0.050048828f, -0.072021484f, 0.0020809174f, 0.05609131f, 0.002796173f, 0.0019798279f, -0.0012483597f, 0.037109375f, 0.035003662f, 0.03225708f, -0.015975952f, 0.005596161f, -0.025344849f, -0.0059776306f, 0.0037078857f, 0.021835327f, -0.006412506f, 0.018661499f, 0.011886597f, 0.009757996f, 0.019714355f, 0.010444641f, -0.06781006f, -0.056610107f, 0.028274536f, 0.018051147f, 0.0049819946f, -0.045532227f, -1.7368793E-4f, 0.04763794f, -0.028793335f, -0.044799805f, 0.0036792755f, -0.022247314f, 0.030532837f, -0.02861023f, 0.010040283f, 0.015792847f, 0.015136719f, 0.084106445f, -0.021026611f, -0.026657104f, 0.004096985f, 0.05618286f, -0.028915405f, -0.03314209f, -2.6583672E-4f, 0.032958984f, 0.041900635f, 0.032409668f, 0.028656006f, 7.092953E-5f, 0.009605408f, -0.0053138733f, 0.044677734f, -0.018859863f, 0.016601562f, 0.016143799f, -0.054718018f, -0.010719299f, -0.028457642f, 0.010551453f, -0.032165527f, -0.0036716461f, 0.008834839f, 0.0287323f, -0.010536194f, 0.022201538f, -0.0065994263f, 0.053619385f, -0.035705566f, -0.04034424f, -0.03933716f, -0.006664276f, -0.034362793f, 0.036865234f, 0.006111145f, 0.027038574f, 0.059326172f, -0.005012512f, 0.0034713745f, -0.055419922f, -0.040802002f, 0.017501831f, 0.011711121f, -0.06378174f, 0.0038585663f, -0.006793976f, 0.0067825317f, 0.0075416565f, -0.010269165f, 0.0069007874f, -0.1381836f, 0.015174866f, -0.030639648f, 0.054718018f, -0.042388916f, 0.008590698f, -0.04864502f, -0.017501831f, -0.014442444f, 0.009010315f, 0.0073394775f, -0.06744385f, -0.004360199f, -0.0034923553f, 0.005886078f, 0.025924683f, 0.010429382f, -0.0039711f, -0.0098724365f, -0.013214111f, -0.0013942719f, 0.031829834f, 7.9488754E-4f, -0.02407837f, 3.8933754E-4f, -6.122589E-4f, 0.0027122498f, 0.041534424f, 0.045288086f, -0.004348755f, -0.048980713f, 0.018920898f, -0.008811951f, 0.0021820068f, 0.018035889f, 0.009437561f, 0.05618286f, -0.052124023f, -0.020645142f, -0.034851074f, -0.02784729f, -0.0010900497f, -0.009483337f, -0.0013189316f, -0.012878418f, 0.025604248f, 0.035980225f, 0.0041503906f, -0.024261475f, -0.014831543f, -0.005622864f, 0.03668213f, -0.048217773f, 0.015609741f, -0.013885498f, 0.0118637085f, 0.04269409f, -0.06512451f, 0.014190674f, -0.013175964f, -0.016860962f, -0.0062675476f, 0.008270264f, 0.047821045f, 0.020629883f, -0.0065193176f, 6.213188E-4f, -0.04348755f, -0.04977417f, -0.0033779144f, -0.017578125f, -0.021469116f, -0.0044021606f, -0.014343262f, -0.033050537f, -0.017959595f, -0.038848877f, -0.0018701553f, -0.034698486f, 0.024658203f, -0.014701843f, -0.00907135f, 0.0042915344f, -0.08880615f, -0.025985718f, 0.046875f, 0.027511597f, 0.013664246f, -0.03213501f, 0.101135254f, 0.038330078f, 0.013519287f, -0.044036865f, -0.010826111f, -0.035614014f, 0.026306152f, -0.0040016174f, 0.0048179626f, 0.008850098f, -0.008255005f, -0.031921387f, -0.0121154785f, 0.015213013f, 0.013076782f, 0.013381958f, 0.009338379f, -0.0143585205f, 0.014305115f, 0.040222168f, -0.038879395f, -0.019363403f, 0.010734558f, 0.03213501f, -0.043182373f, -0.0069732666f, -0.018585205f, -0.028564453f, 0.036621094f, -0.041870117f, 0.01525116f, 0.015808105f, 0.0038928986f, 0.022994995f, 0.06689453f, -0.0079956055f, -0.0029888153f, 0.0440979f, 0.008834839f, -0.0063591003f, 0.023880005f, -0.020584106f, -0.0463562f, -0.0036201477f, 0.011680603f, -0.013076782f, -0.028121948f, 0.028274536f, 0.009483337f, 0.0053901672f, 0.019439697f, -0.054718018f, 0.020477295f, -0.0074424744f, -0.04269409f, 0.018798828f, -0.0035705566f, 0.016174316f, -0.0030021667f, 0.007987976f, -0.025161743f, -0.027038574f, 0.017852783f, -0.018356323f, 0.016098022f, -0.010009766f, 0.01838684f, 0.07531738f, -0.006801605f, -0.004257202f, 0.015571594f, 0.037750244f, 0.04751587f, -0.03967285f, 0.03491211f, 0.009918213f, 0.035217285f, 0.007068634f, 0.0059165955f, -0.007850647f, 0.047088623f, -0.010536194f, -0.054901123f, -0.015930176f, 0.0071525574f, -0.05758667f, 0.017532349f, -0.034820557f, -0.024414062f, 0.013252258f, -0.03677368f, -0.0028648376f, -0.017868042f, -0.007987976f, -0.030792236f, 0.048034668f, 0.0067214966f, 0.045684814f, -0.0051879883f, -0.028152466f, 0.04815674f, 0.013923645f, 0.044799805f, 6.23703E-4f, -0.089538574f, -0.004173279f, -0.02947998f, -0.015319824f, 0.08105469f, -0.0028629303f, 0.011909485f, -0.011245728f, -0.022705078f, 0.060333252f, -0.012939453f, -0.0040245056f, 0.0118637085f, 0.055541992f, -0.01689148f, 0.030792236f, -0.0076828003f, 0.056549072f, 0.20996094f, 0.014930725f, 0.004497528f, -0.07965088f, 5.559921E-4f, -0.032165527f, 0.023544312f, -0.024627686f, -0.008140564f, -0.006313324f, 0.0074157715f, 0.051940918f, 0.029327393f, 0.016525269f, 0.026321411f, 0.087646484f, -0.016021729f, -0.022949219f, 0.01802063f, 0.010513306f, 0.016571045f, 0.058746338f, -0.0074272156f, -0.028961182f, 0.0063056946f, -0.018463135f, 0.01676941f, -0.019119263f, 0.009338379f, 0.027938843f, -0.07611084f, 0.014305115f, -0.05328369f, 0.034606934f, 0.009315491f, -0.00680542f, 0.009262085f, 0.021347046f, -0.04296875f, 0.026428223f, 0.012413025f, -0.011665344f, -0.0129470825f, -0.0059814453f, -0.021347046f, -0.023788452f, -0.04449463f, -0.005569458f, -0.027328491f, 0.04736328f, -0.051940918f, 0.036712646f, 0.034210205f, -0.025024414f, 0.031982422f, -0.0031108856f, 0.0046463013f, -0.04562378f, -0.036315918f, -0.10223389f, 0.019515991f, 0.012481689f, 0.03866577f, -0.01776123f, -0.01512146f, -2.515316E-5f, 0.0017700195f, 0.039245605f, 0.036956787f, -0.006088257f, 0.05218506f, 0.018829346f, -0.019256592f, -0.03050232f, 0.022659302f, 0.010932922f, 0.034362793f, 0.028274536f, -0.038238525f, -0.011421204f, -0.047729492f, 0.008384705f, 0.026397705f, -0.0012645721f, -0.040863037f, 0.016220093f, 0.036102295f, -0.018249512f, 0.023010254f, 0.012809753f, -0.02571106f, 0.018707275f, -0.019989014f, 0.0118637085f, -0.0109939575f, 0.04095459f, -0.00844574f, 0.013458252f, -0.022277832f, 0.041748047f, 0.051208496f, 0.008987427f, -0.027038574f, 0.056243896f, 0.048339844f, -0.016693115f, 0.034210205f, -0.040771484f, -0.037841797f, 0.008392334f, -0.0034732819f, -0.015670776f, -0.01121521f, -0.077697754f, -0.031173706f, -0.04095459f, -0.029449463f, -0.026428223f, 0.021102905f, -0.02520752f, 0.027450562f, -0.04095459f, -0.0024967194f, -0.057373047f, -0.0038585663f, 0.0039711f, 0.014526367f, -0.053527832f, -0.0030097961f, -0.04763794f, 0.012466431f, 0.016555786f, 0.02281189f, -0.0031032562f, 0.04107666f, 0.0146102905f, -9.717941E-4f, 0.030166626f, -0.04977417f, -0.019073486f, -0.010795593f, -0.030151367f, -0.02204895f, -0.011169434f, -0.05038452f, 0.027923584f, 0.05569458f, -0.0047073364f, 0.027252197f, -0.00111866f, -0.091308594f, -0.0073509216f, -0.02583313f, -0.021377563f, -0.019104004f, 0.0032577515f, -0.025970459f, -0.0146102905f, -0.038482666f, 0.005405426f, 0.05001831f, 0.0071144104f, 0.025604248f, -0.005302429f, 0.0087509155f, 0.003326416f, 0.03086853f, 0.022369385f, 0.023330688f, -0.01322937f, 0.009284973f, 0.06903076f, 0.023910522f, 0.02709961f, -0.05444336f, -0.002943039f, 0.02180481f, -0.029663086f, 0.04763794f, -0.025436401f, -0.017532349f, 0.062805176f, 0.00497818f, 0.030883789f, -0.046020508f, -0.025131226f, 0.0063819885f, 0.011726379f, 0.013641357f, -0.0069732666f, 0.0071792603f, -0.0129852295f, 0.024353027f, 0.014724731f, 0.02015686f, 0.020874023f, -0.009552002f, -0.002729416f, 0.0057258606f, -0.033569336f, 0.05999756f, -0.03414917f, 0.003276825f, 0.029846191f, 0.049591064f, -0.019241333f, 0.045135498f, 0.04547119f, -0.012565613f, 0.03201294f, 0.019012451f, -0.03668213f, -0.031341553f, 0.012420654f, 0.043762207f, 0.03050232f, 0.007095337f, -0.008636475f, 0.009414673f, -0.015991211f, -0.062438965f, 0.0413208f, -0.009811401f, 0.008613586f, 4.4178963E-4f, 0.024734497f, -0.004047394f, 0.0055770874f, -0.02758789f, -0.0012454987f, 0.0413208f, -0.008331299f, -0.05014038f, -6.637573E-4f, -0.0047912598f, 0.006980896f, 0.010871887f, 0.0036201477f, 0.026489258f, -0.02973938f, -0.0345459f, -0.02507019f, 0.0063819885f, -0.0017623901f, -0.025970459f, -0.037902832f, 0.0357666f, 0.08380127f, -0.026000977f, 0.014152527f, 0.0032482147f, -0.013473511f, 0.0049819946f, -0.014213562f, 0.022201538f, -0.02784729f, 0.019592285f, 0.0019550323f, -0.011741638f, -0.020858765f, -0.022918701f, 0.02368164f, -0.023773193f, -0.008674622f, -0.011001587f, 0.035736084f, -0.010154724f, -0.035064697f, -0.03753662f, -0.053985596f, -0.01436615f, -8.7070465E-4f, 4.887581E-4f, -0.051605225f, 0.019607544f, 0.036132812f, -0.032928467f, -0.018920898f, -0.024658203f, 0.022827148f, 0.06378174f, 0.064575195f, -0.028656006f, 0.037475586f, 0.046722412f, 0.024871826f, 0.0047073364f, -0.009902954f, -0.03086853f, 2.8252602E-4f, -0.012207031f, 0.00831604f, -0.04421997f, 0.02406311f, -0.005908966f, -0.011940002f, 0.015563965f, 0.010757446f, -0.013648987f, 0.019821167f, 0.041656494f, 0.048461914f, 0.035705566f, -0.004135132f, 0.020980835f, -0.0033550262f, 0.01096344f, 0.016067505f, 0.0178833f, 0.0012598038f, 0.0046691895f, 0.046875f, -0.02381897f, 0.004501343f, 0.026657104f, -0.004798889f, 0.05871582f, 0.0025024414f, 0.017562866f, -0.0017290115f, -0.0077209473f, 0.04348755f, -0.011116028f, 0.007499695f, 0.039031982f, 0.014457703f, -0.010559082f, 0.009048462f, 0.03765869f, -0.012161255f, 0.00283432f, -0.012458801f, 0.05368042f, 0.011909485f, -0.023773193f, -0.0033168793f, -0.009674072f, 0.023117065f, -0.0058174133f, -0.0065994263f, -0.019195557f, 0.021026611f, -0.01574707f, 7.543564E-4f, -0.005077362f, -0.035217285f, -0.028320312f, 0.029403687f, 0.0029773712f, -0.015098572f, 0.034698486f, -0.0030441284f, 0.031051636f, -0.04232788f, 0.011833191f, 4.8828125E-4f, -0.014801025f, -8.404255E-5f, -0.027862549f })
            .IncludeScores(true)
            .IncludeSortVector(true)
            .SetRerankOn("Name")
            .Project(Builders<HybridSearchTestObject>.Projection.Include(x => x.Name))
            .SetRerankQuery(rerankQuery);
        var resultList = results.ToList();
        Assert.NotNull(resultList);
        Assert.NotEmpty(resultList);
        Assert.Contains(resultList, r => r.Name == "Cat");
    }

}

